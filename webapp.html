<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ğ‘ĞµĞ»Ğ¾Ñ‚</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="stylesheet" href="https://deck-of-cards.js.org/example/example.css">
<script src="https://deck-of-cards.js.org/dist/deck.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #1a6b3a;
    background-image:
      radial-gradient(ellipse at 50% 0%, #2d8f52 0%, #1a6b3a 60%),
      repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 11px);
    min-height: 100vh;
    color: #fff;
    overflow-x: hidden;
    user-select: none;
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #header {
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(8px);
    padding: 10px 14px 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  #round-info { font-size: 13px; opacity: 0.75; }
  #trump-display { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
  #trump-suit { font-size: 22px; }
  #tricks-count { font-size: 13px; opacity: 0.8; }

  /* â”€â”€ Scores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #scores {
    display: flex; gap: 8px; padding: 8px 14px;
    background: rgba(0,0,0,0.2);
  }
  .score-team {
    flex: 1; background: rgba(0,0,0,0.25); border-radius: 10px;
    padding: 7px 10px; border-left: 3px solid #4a90d9;
  }
  .score-team.red { border-left-color: #e05050; }
  .score-team .names { font-size: 11px; opacity: 0.75; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .score-team .pts { font-size: 20px; font-weight: 700; }
  .score-bar { height: 3px; background: rgba(255,255,255,0.15); border-radius: 2px; margin-top: 4px; }
  .score-bar-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, #4a90d9, #74bcff); transition: width 0.5s; }
  .score-team.red .score-bar-fill { background: linear-gradient(90deg, #e05050, #ff8080); }

  /* â”€â”€ Table (current trick) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #table-area { padding: 10px 14px 6px; min-height: 110px; }
  #table-label { font-size: 11px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  #trick-cards { display: flex; gap: 8px; align-items: flex-end; min-height: 90px; }
  .trick-slot { display: flex; flex-direction: column; align-items: center; gap: 3px; }
  .trick-name { font-size: 10px; opacity: 0.7; max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* â”€â”€ Status message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #status-bar { text-align: center; padding: 6px 14px; font-size: 13px; min-height: 28px; opacity: 0.9; }
  #status-bar.my-turn { color: #ffe066; font-weight: 600; }
  #status-bar.waiting { color: rgba(255,255,255,0.6); }

  /* â”€â”€ Hand area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #hand-label { font-size: 11px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; padding: 0 14px 4px; }
  #hand-area { padding: 0 8px 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  #hand-cards { display: flex; gap: 6px; padding: 8px 4px 12px; min-width: max-content; }

  /* â”€â”€ Card SVG wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card-wrap {
    display: flex; flex-direction: column; align-items: center;
    gap: 4px; cursor: pointer; transition: transform 0.15s ease; position: relative;
  }
  .card-wrap svg { filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4)); transition: filter 0.15s; }
  .card-wrap.valid:hover svg, .card-wrap.valid:active svg {
    filter: drop-shadow(0 5px 12px rgba(255,220,50,0.5)) drop-shadow(0 3px 6px rgba(0,0,0,0.4));
  }
  .card-wrap.selected { transform: translateY(-14px); }
  .card-wrap.selected svg { filter: drop-shadow(0 8px 16px rgba(255,220,50,0.7)) drop-shadow(0 3px 6px rgba(0,0,0,0.4)); }
  .card-wrap.invalid { opacity: 0.45; cursor: default; }
  .card-wrap.trump-card svg { filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4)) drop-shadow(0 0 4px rgba(255,200,0,0.3)); }

  /* â”€â”€ Deck-of-cards library overrides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* Scale and clip library cards to fit our UI */
  .doc-card-wrap {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* The library creates .card elements â€” scale them down for our hand */
  .doc-card-wrap .card {
    transform-origin: top left;
    transform: scale(0.62);
    margin: 0 !important;
    position: relative !important;
    left: auto !important;
    top: auto !important;
    float: none !important;
    display: block;
    flex-shrink: 0;
  }

  /* Smaller cards for the trick area */
  .doc-small .card {
    transform: scale(0.50);
  }

  /* Compensate for scale â€” avoid huge invisible hit areas */
  .doc-card-wrap {
    width: 70px;
    height: 100px;
    overflow: visible;
  }
  .doc-small {
    width: 56px;
    height: 80px;
  }

  /* Trump: golden glow border */
  .doc-trump .card {
    box-shadow: 0 0 0 3px #f0c040, 0 4px 14px rgba(0,0,0,0.5) !important;
    border-radius: 8px;
  }

  /* Invalid: greyscale + dim */
  .doc-invalid .card {
    filter: grayscale(70%) brightness(0.75);
  }

  /* Trump star badge */
  .doc-trump-star {
    position: absolute;
    top: 2px; right: 4px;
    font-size: 11px;
    color: #f0c040;
    text-shadow: 0 1px 3px rgba(0,0,0,0.6);
    pointer-events: none;
    z-index: 10;
  }

  /* Card hover/active effects via parent .card-wrap */
  .card-wrap.valid:hover .doc-card-wrap .card,
  .card-wrap.valid:active .doc-card-wrap .card {
    box-shadow: 0 0 0 2px #ffe066, 0 6px 18px rgba(255,220,50,0.5) !important;
  }
  .card-wrap.selected .doc-card-wrap .card {
    box-shadow: 0 0 0 3px #ffe066, 0 8px 22px rgba(255,220,50,0.7) !important;
  }
  .card-wrap.trump-card.valid:hover .doc-card-wrap .card {
    box-shadow: 0 0 0 3px #ffd700, 0 6px 18px rgba(255,200,0,0.6) !important;
  }

  /* â”€â”€ Action buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #action-area { padding: 6px 14px 10px; display: flex; flex-direction: column; gap: 8px; }
  .action-btn {
    width: 100%; padding: 13px; border: none; border-radius: 12px;
    font-size: 15px; font-weight: 600; cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
  }
  .action-btn:active { transform: scale(0.97); opacity: 0.85; }
  .btn-primary { background: linear-gradient(135deg, #4CAF50, #2e7d32); color: #fff; }
  .btn-pass { background: rgba(255,255,255,0.12); color: #fff; }
  .btn-take { background: linear-gradient(135deg, #2196F3, #1565c0); color: #fff; }
  .btn-danger { background: linear-gradient(135deg, #e53935, #b71c1c); color: #fff; }
  .btn-suit { background: rgba(255,255,255,0.1); color: #fff; font-size: 18px; border-radius: 12px; padding: 12px; }
  .suits-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

  /* â”€â”€ Confirm discard button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #confirm-discard-btn {
    display: none; position: fixed; bottom: 16px; left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #e53935, #b71c1c);
    color: #fff; border: none; border-radius: 14px; padding: 14px 32px;
    font-size: 16px; font-weight: 700; cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 100;
  }

  /* â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .screen { display: none !important; }
  .screen.active { display: block !important; }
  #lobby-screen.active { display: flex !important; }
  #waiting-screen.active { display: flex !important; }
  #result-screen.active { display: flex !important; }

  /* â”€â”€ Lobby screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #lobby-screen {
    display: none;
    flex-direction: column;
    min-height: 100vh;
  }
  #lobby-screen.active { display: flex; }

  .lobby-header {
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(8px);
    padding: 16px 16px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    text-align: center;
  }
  .lobby-header .logo { font-size: 36px; margin-bottom: 4px; }
  .lobby-header h1 { font-size: 22px; font-weight: 800; letter-spacing: 1px; }
  .lobby-header p { font-size: 12px; opacity: 0.6; margin-top: 2px; }

  .lobby-body { flex: 1; padding: 14px; overflow-y: auto; }

  .lobby-section-title {
    font-size: 11px; opacity: 0.6; text-transform: uppercase;
    letter-spacing: 1px; margin-bottom: 10px;
    display: flex; align-items: center; gap: 8px;
  }
  .lobby-section-title::after {
    content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.15);
  }

  .table-card {
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.15s;
    cursor: pointer;
  }
  .table-card:active { background: rgba(0,0,0,0.5); }
  .table-card:hover { background: rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.2); }

  .table-icon {
    width: 48px; height: 48px; border-radius: 12px;
    background: linear-gradient(135deg, #2e7d32, #1b5e20);
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; flex-shrink: 0;
  }
  .table-info { flex: 1; min-width: 0; }
  .table-id { font-size: 16px; font-weight: 700; font-family: monospace; letter-spacing: 2px; }
  .table-players { font-size: 12px; opacity: 0.7; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .table-mode { font-size: 11px; opacity: 0.5; margin-top: 2px; }

  .table-slots {
    display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0;
  }
  .slots-badge {
    background: rgba(255,255,255,0.1);
    border-radius: 20px; padding: 3px 10px;
    font-size: 12px; font-weight: 600;
  }
  .slots-badge.open { background: rgba(76,175,80,0.3); color: #81c784; }
  .slots-badge.full { background: rgba(229,57,53,0.3); color: #e57373; }

  .join-btn {
    background: linear-gradient(135deg, #4CAF50, #2e7d32);
    border: none; color: #fff; border-radius: 10px;
    padding: 7px 16px; font-size: 13px; font-weight: 700;
    cursor: pointer; white-space: nowrap;
  }
  .join-btn:disabled { opacity: 0.4; cursor: default; }

  .seats-dots { display: flex; gap: 4px; }
  .seat-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: rgba(255,255,255,0.2);
  }
  .seat-dot.filled { background: #4CAF50; }

  .empty-lobby {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; padding: 48px 24px; gap: 12px;
    opacity: 0.6; text-align: center;
  }
  .empty-lobby .icon { font-size: 48px; }
  .empty-lobby p { font-size: 14px; line-height: 1.5; }

  .lobby-footer {
    padding: 12px 16px;
    background: rgba(0,0,0,0.3);
    border-top: 1px solid rgba(255,255,255,0.08);
    display: flex;
    gap: 8px;
  }
  .lobby-footer button {
    flex: 1; padding: 12px; border: none; border-radius: 12px;
    font-size: 14px; font-weight: 600; cursor: pointer;
  }
  .btn-new-game {
    background: linear-gradient(135deg, #2196F3, #1565c0);
    color: #fff;
  }
  .btn-refresh {
    background: rgba(255,255,255,0.1);
    color: #fff;
    flex: 0 0 48px !important;
    font-size: 18px !important;
  }

  .refresh-spin { animation: spin 0.6s linear; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  /* â”€â”€ Create game modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #create-modal {
    display: none;
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    align-items: center; justify-content: center;
  }
  .modal-box {
    background: #1e5c30;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px;
    padding: 28px 24px;
    width: 90%; max-width: 320px;
    text-align: center;
  }
  .modal-box h2 { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
  .modal-box p { font-size: 13px; opacity: 0.7; margin-bottom: 20px; }
  .modal-options { display: flex; flex-direction: column; gap: 10px; }
  .modal-option-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 14px; color: #fff;
    padding: 14px; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: background 0.15s;
  }
  .modal-option-btn:hover { background: rgba(255,255,255,0.2); }
  .modal-option-btn.highlight {
    background: linear-gradient(135deg, #2196F3, #1565c0);
    border-color: transparent;
  }
  .modal-cancel {
    margin-top: 10px; background: none; border: none;
    color: rgba(255,255,255,0.5); font-size: 14px; cursor: pointer;
    padding: 8px;
  }

  /* â”€â”€ Waiting in room â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #waiting-screen {
    flex-direction: column; align-items: center;
    justify-content: center; min-height: 70vh; gap: 14px; padding: 24px;
  }
  .waiting-icon { font-size: 64px; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
  .waiting-title { font-size: 22px; font-weight: 700; }
  .waiting-sub { font-size: 14px; opacity: 0.7; text-align: center; }

  .player-list {
    background: rgba(0,0,0,0.25); border-radius: 12px;
    padding: 12px 16px; width: 100%; max-width: 300px;
  }
  .player-list-item {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.07);
    font-size: 14px;
  }
  .player-list-item:last-child { border-bottom: none; }
  .player-dot { width: 8px; height: 8px; border-radius: 50%; background: #4CAF50; }
  .empty-slot { opacity: 0.35; }
  .empty-slot .player-dot { background: rgba(255,255,255,0.3); }

  #result-screen {
    flex-direction: column; align-items: center;
    justify-content: center; min-height: 70vh;
    gap: 14px; padding: 24px; text-align: center;
  }
  .result-icon { font-size: 72px; }
  .result-title { font-size: 28px; font-weight: 800; }
  .result-sub { font-size: 15px; opacity: 0.8; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  LOBBY SCREEN â€” list of open tables                -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="lobby-screen" class="screen">
  <div class="lobby-header">
    <div class="logo">ğŸƒ</div>
    <h1>Ğ‘ĞµĞ»Ğ¾Ñ‚</h1>
    <p>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾Ğ» Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¸Ğ³Ñ€Ñƒ</p>
  </div>

  <div class="lobby-body">
    <div class="lobby-section-title">ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ ÑÑ‚Ğ¾Ğ»Ñ‹</div>
    <div id="tables-list">
      <div class="empty-lobby">
        <div class="icon">ğŸ”</div>
        <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑÑ‚Ğ¾Ğ»Ğ¾Ğ²...</p>
      </div>
    </div>
  </div>

  <div class="lobby-footer">
    <button class="lobby-footer button btn-new-game" onclick="requestNewGame()">
      â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾Ğ»
    </button>
    <button class="lobby-footer button btn-refresh" id="refresh-btn" onclick="loadLobby()">
      ğŸ”„
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  WAITING ROOM â€” joined, waiting for others         -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="waiting-screen" class="screen">
  <div class="waiting-icon">â³</div>
  <div class="waiting-title">Ğ–Ğ´Ñ‘Ğ¼ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²</div>
  <div class="waiting-sub" id="waiting-msg">Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ¾Ğ»...</div>
  <div class="player-list" id="waiting-player-list"></div>
  <div style="font-size:12px;opacity:0.5;margin-top:8px">Ğ˜Ğ³Ñ€Ğ° Ğ½Ğ°Ñ‡Ğ½Ñ‘Ñ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸</div>
  <button id="leave-btn" onclick="leaveTable()" style="
    margin-top:20px; background:rgba(229,57,53,0.2); border:1px solid rgba(229,57,53,0.4);
    color:#ef9a9a; border-radius:12px; padding:11px 28px;
    font-size:14px; font-weight:600; cursor:pointer;">
    ğŸšª Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ğ»Ğ°
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  GAME SCREEN                                       -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game-screen" class="screen">
  <div id="header">
    <div id="round-info">Ğ Ğ°ÑƒĞ½Ğ´ <span id="round-num">1</span></div>
    <div id="trump-display">
      <span>â˜…</span>
      <span id="trump-suit">?</span>
    </div>
    <div id="tricks-count">ğŸ”µ<span id="tricks0">0</span> ğŸ”´<span id="tricks1">0</span></div>
  </div>

  <div id="scores">
    <div class="score-team" id="score-t0">
      <div class="names" id="t0-names">ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° 1</div>
      <div class="pts" id="t0-pts">0</div>
      <div class="score-bar"><div class="score-bar-fill" id="t0-bar" style="width:0%"></div></div>
    </div>
    <div class="score-team red" id="score-t1">
      <div class="names" id="t1-names">ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° 2</div>
      <div class="pts" id="t1-pts">0</div>
      <div class="score-bar"><div class="score-bar-fill" id="t1-bar" style="width:0%"></div></div>
    </div>
  </div>

  <div id="table-area">
    <div id="table-label">ĞĞ° ÑÑ‚Ğ¾Ğ»Ğµ</div>
    <div id="trick-cards"></div>
  </div>

  <div id="status-bar"></div>

  <div id="hand-label">Ğ’Ğ°ÑˆĞ¸ ĞºĞ°Ñ€Ñ‚Ñ‹</div>
  <div id="hand-area">
    <div id="hand-cards"></div>
  </div>

  <div id="action-area"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  RESULT SCREEN                                     -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="result-screen" class="screen">
  <div class="result-icon" id="result-icon">ğŸ…</div>
  <div class="result-title" id="result-title">Ğ Ğ°ÑƒĞ½Ğ´ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½</div>
  <div class="result-sub" id="result-sub"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  CREATE GAME MODAL                                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="create-modal">
  <div class="modal-box">
    <h2>ğŸƒ ĞĞ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¾Ğ»</h2>
    <p>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²</p>
    <div class="modal-options">
      <button class="modal-option-btn highlight" onclick="createGame(4)">
        ğŸ‘¥ 4 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° â€” 2 ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
      </button>
      <button class="modal-option-btn" onclick="createGame(3)">
        ğŸ‘¤ 3 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° â€” 1 Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² 2
      </button>
    </div>
    <button class="modal-cancel" onclick="closeCreateModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
  </div>
</div>

<button id="confirm-discard-btn" onclick="confirmDiscard()">ğŸ—‘ Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ (0/2)</button>

<script>
// â”€â”€ Telegram WebApp init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = null;
let myId = null;
let myName = 'Ğ˜Ğ³Ñ€Ğ¾Ğº';
let selectedDiscard = [];
let selectedPlayCard = null;
let lobbyRefreshTimer = null;
let waitingRefreshTimer = null;
let currentWaitingState = null;

// Get Telegram user info
const tgUser = tg?.initDataUnsafe?.user;
if (tgUser) {
  myId = tgUser.id;
  myName = tgUser.first_name || 'Ğ˜Ğ³Ñ€Ğ¾Ğº';
  if (tgUser.last_name) myName += ' ' + tgUser.last_name;
}

// â”€â”€ Deck-of-Cards library integration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Lazily initialise the full 52-card deck once the library has loaded.
let _deckInstance = null;
function getDeck() {
  if (!_deckInstance && typeof Deck !== 'undefined') {
    _deckInstance = Deck();
  }
  return _deckInstance;
}

// Map Belot rank strings â†’ library rank index (A=0, 2=1 â€¦ K=12)
const RANK_TO_LIB = { 'A':0,'7':6,'8':7,'9':8,'10':9,'J':10,'Q':11,'K':12 };
// Map Belot suit symbols â†’ library suit index (â™£=0, â™¦=1, â™¥=2, â™ =3)
const SUIT_TO_LIB = { 'â™£':0,'â™¦':1,'â™¥':2,'â™ ':3 };

/**
 * Get (or clone-style) a deck-of-cards card element for a given rank/suit.
 * Returns a <div> DOM element that looks like a real playing card.
 * We mount into a hidden staging area and clone nodes as needed.
 */
const _cardCache = {};
function getLibraryCardEl(rank, suit) {
  const key = rank + suit;
  if (_cardCache[key]) return _cardCache[key].cloneNode(true);

  const deck = getDeck();
  if (!deck) return null;  // library not loaded yet â€” caller falls back to SVG

  const rIdx = RANK_TO_LIB[rank];
  const sIdx = SUIT_TO_LIB[suit];
  if (rIdx === undefined || sIdx === undefined) return null;

  const cardObj = deck.cards[sIdx * 13 + rIdx];
  if (!cardObj) return null;

  // Mount to a staging div to generate its DOM
  const staging = document.createElement('div');
  staging.style.cssText = 'position:fixed;left:-9999px;top:-9999px;visibility:hidden';
  document.body.appendChild(staging);
  cardObj.mount(staging);
  cardObj.setSide('front');

  // Grab the element, cache it, clean up
  const el = cardObj.el;
  _cardCache[key] = el.cloneNode(true);
  document.body.removeChild(staging);
  return _cardCache[key].cloneNode(true);
}

/**
 * Create a styled card wrapper element using the deck-of-cards library.
 * Falls back to SVG rendering if the library hasn't loaded.
 */
function makeCardEl(rank, suit, { trump = false, invalid = false, small = false } = {}) {
  const wrapper = document.createElement('div');
  wrapper.classList.add('doc-card-wrap');
  if (trump)   wrapper.classList.add('doc-trump');
  if (invalid) wrapper.classList.add('doc-invalid');
  if (small)   wrapper.classList.add('doc-small');

  const libEl = getLibraryCardEl(rank, suit);
  if (libEl) {
    wrapper.appendChild(libEl);
  } else {
    // Fallback: simple SVG while library loads
    const SUIT_COLOR = { 'â™£':'#1a1a2e','â™ ':'#1a1a2e','â™¥':'#c0392b','â™¦':'#c0392b' };
    const color = SUIT_COLOR[suit] || '#1a1a2e';
    const w = small ? 52 : 64, h = small ? 76 : 96;
    wrapper.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <rect x="0" y="0" width="${w-2}" height="${h-2}" rx="7" fill="white" stroke="${trump?'#f0c040':'#ccc'}" stroke-width="${trump?2.5:1.5}"/>
      <text x="5" y="18" font-size="13" font-weight="bold" font-family="Arial" fill="${color}">${rank}</text>
      <text x="5" y="32" font-size="14" font-family="Arial" fill="${color}">${suit}</text>
      <text x="${(w-2)/2}" y="${(h-2)/2+4}" font-size="24" font-family="Arial" fill="${color}" text-anchor="middle">${suit}</text>
    </svg>`;
  }

  if (trump) {
    const star = document.createElement('span');
    star.className = 'doc-trump-star';
    star.textContent = 'â˜…';
    wrapper.appendChild(star);
  }
  return wrapper;
}

// Keep makeCardSVG as thin wrapper for backward-compat (trick renderer)
function makeCardSVG(rank, suit, options = {}) {
  // Returns HTML string â€” used by renderTrick innerHTML approach
  const { w = 64, h = 96, trump = false, invalid = false } = options;
  const SUIT_COLOR = { 'â™£':'#1a1a2e','â™ ':'#1a1a2e','â™¥':'#c0392b','â™¦':'#c0392b' };
  const color = SUIT_COLOR[suit] || '#1a1a2e';
  const opacity = invalid ? 0.5 : 1;
  return `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" opacity="${opacity}">
  <rect x="2" y="2" width="${w-2}" height="${h-2}" rx="8" fill="rgba(0,0,0,0.18)"/>
  <rect x="0" y="0" width="${w-2}" height="${h-2}" rx="8" fill="white" stroke="${trump?'#f0c040':'#ccc'}" stroke-width="${trump?2.5:1.5}"/>
  ${trump?`<rect x="3" y="3" width="${w-8}" height="${h-8}" rx="6" fill="none" stroke="#ffe08880" stroke-width="1.5"/>`:''}
  <text x="5" y="17" font-size="12" font-weight="bold" font-family="Arial,sans-serif" fill="${color}">${rank}</text>
  <text x="5" y="30" font-size="13" font-family="Arial,sans-serif" fill="${color}">${suit}</text>
  <text x="${(w-2)/2}" y="${(h-2)/2+4}" font-size="22" font-family="Arial,sans-serif" fill="${color}" text-anchor="middle">${suit}</text>
  ${trump?`<text x="${w-8}" y="14" font-size="9" fill="#f0c040" text-anchor="middle">â˜…</text>`:''}
</svg>`;
}

// â”€â”€ LOBBY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLobby() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('refresh-spin');
  setTimeout(() => btn.classList.remove('refresh-spin'), 600);

  try {
    const res = await fetch('/api/lobby');
    const data = await res.json();
    renderTables(data.games || []);
  } catch (e) {
    document.getElementById('tables-list').innerHTML = `
      <div class="empty-lobby">
        <div class="icon">âš ï¸</div>
        <p>ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ğ»Ñ‹.<br>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ.</p>
      </div>`;
  }
}

function renderTables(games) {
  const container = document.getElementById('tables-list');
  if (games.length === 0) {
    container.innerHTML = `
      <div class="empty-lobby">
        <div class="icon">ğŸƒ</div>
        <p>ĞĞµÑ‚ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… ÑÑ‚Ğ¾Ğ»Ğ¾Ğ².<br>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¸Ğ³Ñ€Ñƒ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾Ğ»Â».</p>
      </div>`;
    return;
  }

  container.innerHTML = games.map(g => {
    const filled = g.slots_taken;
    const total = g.slots_total;
    const isFull = filled >= total;
    const dots = Array.from({length: total}, (_, i) =>
      `<div class="seat-dot ${i < filled ? 'filled' : ''}"></div>`
    ).join('');
    const playerList = g.players.join(', ') || 'ĞŸÑƒÑÑ‚Ğ¾';

    return `
    <div class="table-card" onclick="joinTable('${g.game_id}')">
      <div class="table-icon">ğŸƒ</div>
      <div class="table-info">
        <div class="table-id">${g.game_id}</div>
        <div class="table-players">ğŸ‘¤ ${playerList}</div>
        <div class="table-mode">${g.mode}</div>
      </div>
      <div class="table-slots">
        <div class="slots-badge ${isFull ? 'full' : 'open'}">
          ${filled}/${total}
        </div>
        <div class="seats-dots">${dots}</div>
        <button class="join-btn" ${isFull ? 'disabled' : ''} onclick="event.stopPropagation();joinTable('${g.game_id}')">
          ${isFull ? 'ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹' : 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸'}
        </button>
      </div>
    </div>`;
  }).join('');
}

async function joinTable(gameId) {
  if (!myId) {
    // Browser test mode â€” assign fake ID
    myId = 100000 + Math.floor(Math.random() * 900000);
    myName = 'Ğ˜Ğ³Ñ€Ğ¾Ğº_' + String(myId).slice(-4);
  }

  let data;
  try {
    const res = await fetch('/api/join_lobby', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ game_id: gameId, player_id: myId, player_name: myName }),
    });
    data = await res.json();
  } catch (e) {
    tg?.showAlert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ.');
    if (!tg) alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸: ' + e.message);
    return;
  }

  if (!data.ok) {
    tg?.showAlert(data.error || 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² Ğ¸Ğ³Ñ€Ñƒ');
    if (!tg) alert(data.error || 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² Ğ¸Ğ³Ñ€Ñƒ');
    return;
  }

  // Stop lobby refresh
  clearInterval(lobbyRefreshTimer);

  // Show game state directly â€” works for both waiting room and active game
  updateUI(data.state);
}

function requestNewGame() {
  document.getElementById('create-modal').style.display = 'flex';
}

function closeCreateModal() {
  document.getElementById('create-modal').style.display = 'none';
}

async function createGame(maxPlayers) {
  closeCreateModal();
  if (!myId) {
    // In browser without Telegram â€” use a fake test ID
    myId = 100000 + Math.floor(Math.random() * 900000);
    myName = 'Ğ˜Ğ³Ñ€Ğ¾Ğº_' + String(myId).slice(-4);
  }
  try {
    const res = await fetch('/api/create_game', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ player_id: myId, player_name: myName, max_players: maxPlayers }),
    });
    const data = await res.json();
    if (!data.ok) {
      tg?.showAlert(data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ¾Ğ»Ğ°');
      alert(data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ¾Ğ»Ğ°');
      return;
    }
    clearInterval(lobbyRefreshTimer);
    updateUI(data.state);
  } catch(e) {
    const msg = 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ: ' + e.message;
    tg?.showAlert(msg);
    alert(msg);
  }
}

// â”€â”€ WAITING ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showWaitingRoom(s) {
  showScreen('waiting-screen');
  currentWaitingState = s;

  const filled = s.slots_taken || 0;
  const total = s.slots_total || 4;
  document.getElementById('waiting-msg').textContent =
    `Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²: ${filled}/${total} â€¢ ĞšĞ¾Ğ´: ${s.game_id || '???'}`;

  const listEl = document.getElementById('waiting-player-list');
  const players = s.players || [];
  let html = players.map(name =>
    `<div class="player-list-item"><div class="player-dot"></div>${name}</div>`
  ).join('');
  for (let i = players.length; i < total; i++) {
    html += `<div class="player-list-item empty-slot"><div class="player-dot"></div>ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼...</div>`;
  }
  listEl.innerHTML = html;

  // Show correct label: creator sees "Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ ÑÑ‚Ğ¾Ğ»", others see "Ğ’Ñ‹Ğ¹Ñ‚Ğ¸"
  const leaveBtn = document.getElementById('leave-btn');
  const isCreator = s.is_creator || false;
  leaveBtn.textContent = isCreator ? 'ğŸš« Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ ÑÑ‚Ğ¾Ğ»' : 'ğŸšª Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ğ»Ğ°';
}

// â”€â”€ GAME UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHand(hand, validIndices, trumpSuit, phase) {
  const container = document.getElementById('hand-cards');
  container.innerHTML = '';
  if (!hand || hand.length === 0) {
    container.innerHTML = '<div style="opacity:0.5;padding:20px">ĞĞµÑ‚ ĞºĞ°Ñ€Ñ‚</div>';
    return;
  }
  hand.forEach((card, i) => {
    const [rank, suit] = card;
    const isTrump = suit === trumpSuit;
    const isValid = validIndices === null || validIndices.includes(i);
    const isSelected = (phase === 'discard' && selectedDiscard.includes(i)) ||
                       (phase === 'play' && selectedPlayCard === i);

    const wrap = document.createElement('div');
    wrap.className = 'card-wrap' +
      (isValid ? ' valid' : ' invalid') +
      (isTrump ? ' trump-card' : '') +
      (isSelected ? ' selected' : '');

    // Use deck-of-cards library card element
    const cardEl = makeCardEl(rank, suit, { trump: isTrump, invalid: !isValid });
    wrap.appendChild(cardEl);

    if (isValid) {
      wrap.onclick = () => onCardClick(i, phase);
    } else {
      wrap.onclick = () => tg?.showAlert('Ğ­Ñ‚Ñƒ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ½ĞµĞ»ÑŒĞ·Ñ ÑÑ‹Ğ³Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼!');
    }
    container.appendChild(wrap);
  });
}

function renderTrick(trick, playerNames, trumpSuit) {
  const container = document.getElementById('trick-cards');
  container.innerHTML = '';
  if (!trick || trick.length === 0) {
    container.innerHTML = '<div style="opacity:0.4;font-size:13px;padding:10px 0">Ğ¡Ñ‚Ğ¾Ğ» Ğ¿ÑƒÑÑ‚</div>';
    return;
  }
  trick.forEach(([pid, rank, suit]) => {
    const isTrump = suit === trumpSuit;
    const name = (playerNames || {})[pid] || '?';
    const slot = document.createElement('div');
    slot.className = 'trick-slot';
    const cardEl = makeCardEl(rank, suit, { trump: isTrump, small: true });
    slot.appendChild(cardEl);
    const nameEl = document.createElement('div');
    nameEl.className = 'trick-name';
    nameEl.textContent = name;
    slot.appendChild(nameEl);
    container.appendChild(slot);
  });
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function updateUI(s) {
  state = s;
  clearInterval(waitingRefreshTimer);
  stopGamePolling();

  if (s.phase === 'lobby_waiting') {
    showWaitingRoom(s);
    // Poll every 3s to detect game start
    waitingRefreshTimer = setInterval(() => pollGameState(s.game_id), 3000);
    return;
  }

  if (s.phase === 'waiting') {
    showScreen('waiting-screen');
    document.getElementById('waiting-msg').textContent = s.message || 'ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²...';
    document.getElementById('waiting-player-list').innerHTML = '';
    return;
  }

  if (s.phase === 'result') {
    showScreen('result-screen');
    document.getElementById('result-icon').textContent = s.win ? 'ğŸ†' : 'ğŸ˜”';
    document.getElementById('result-title').textContent = s.title || 'Ğ Ğ°ÑƒĞ½Ğ´ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½';
    document.getElementById('result-sub').textContent = s.message || '';
    return;
  }

  showScreen('game-screen');
  startGamePolling();  // keep state fresh for other players' moves

  document.getElementById('round-num').textContent = s.round || 1;
  document.getElementById('trump-suit').textContent = s.trump || '?';
  document.getElementById('tricks0').textContent = s.tricks ? s.tricks[0] : 0;
  document.getElementById('tricks1').textContent = s.tricks ? s.tricks[1] : 0;

  const target = 151;
  document.getElementById('t0-names').textContent = s.team0_name || 'ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° 1';
  document.getElementById('t1-names').textContent = s.team1_name || 'ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° 2';
  document.getElementById('t0-pts').textContent = s.scores ? s.scores[0] : 0;
  document.getElementById('t1-pts').textContent = s.scores ? s.scores[1] : 0;
  document.getElementById('t0-bar').style.width = Math.min(100, ((s.scores||[0,0])[0] / target * 100)) + '%';
  document.getElementById('t1-bar').style.width = Math.min(100, ((s.scores||[0,0])[1] / target * 100)) + '%';

  renderTrick(s.trick || [], s.player_names || {}, s.trump);

  const statusEl = document.getElementById('status-bar');
  if (s.is_my_turn) {
    statusEl.textContent = 'ğŸ¯ Ğ’Ğ°Ñˆ Ñ…Ğ¾Ğ´!';
    statusEl.className = 'my-turn';
  } else {
    statusEl.textContent = s.waiting_for ? `â³ Ğ¥Ğ¾Ğ´ Ñƒ ${s.waiting_for}` : '';
    statusEl.className = 'waiting';
  }

  document.getElementById('hand-label').style.display = s.hand ? 'block' : 'none';
  if (s.hand) renderHand(s.hand, s.valid_indices, s.trump, s.phase);

  renderActions(s);
}

function renderActions(s) {
  const area = document.getElementById('action-area');
  area.innerHTML = '';
  document.getElementById('confirm-discard-btn').style.display = 'none';

  if (s.phase === 'bid1') {
    area.innerHTML = `
      <button class="action-btn btn-take" onclick="sendAction('bid_take', 'proposed')">
        âœ… Ğ’Ğ·ÑÑ‚ÑŒ ${s.trump} ${s.trump_name}
      </button>
      <button class="action-btn btn-pass" onclick="sendAction('bid_pass')">â­ ĞŸĞ°Ñ</button>`;
  } else if (s.phase === 'bid2') {
    const suits = [['â™£','Ğ¢Ñ€ĞµÑ„Ñ‹'],['â™¦','Ğ‘ÑƒĞ±Ğ½Ñ‹'],['â™¥','Ğ§ĞµÑ€Ğ²Ñ‹'],['â™ ','ĞŸĞ¸ĞºĞ¸']];
    const others = suits.filter(([sv]) => sv !== s.proposed_suit);
    area.innerHTML = `<div class="suits-grid">` +
      others.map(([sv, sn]) => `
        <button class="action-btn btn-suit" onclick="sendAction('bid_take', '${sv}')">
          ${sv} ${sn}
        </button>`).join('') +
      `</div><button class="action-btn btn-pass" onclick="sendAction('bid_pass')">â­ ĞŸĞ°Ñ</button>`;
  } else if (s.phase === 'declare') {
    area.innerHTML = `<button class="action-btn btn-primary" onclick="sendAction('declare')">
      ğŸ“£ Ğ—Ğ°ÑĞ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
    </button>`;
    if (s.declarations && s.declarations.length) {
      const declHtml = s.declarations.map(d => `<div style="font-size:13px;opacity:0.8">ğŸ“Œ ${d}</div>`).join('');
      area.innerHTML = `<div style="padding:8px 0;display:flex;flex-direction:column;gap:4px">${declHtml}</div>` + area.innerHTML;
    } else {
      area.innerHTML = `<div style="font-size:13px;opacity:0.6;padding:4px 0">ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¹ Ğ½ĞµÑ‚</div>` + area.innerHTML;
    }
  } else if (s.phase === 'discard') {
    selectedDiscard = [];
    updateDiscardBtn();
    document.getElementById('confirm-discard-btn').style.display = 'block';
    area.innerHTML = `<div style="font-size:13px;opacity:0.7;text-align:center">ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° 2 ĞºĞ°Ñ€Ñ‚Ñ‹ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¸Ñ…</div>`;
  } else if (s.phase === 'play' && s.is_my_turn) {
    area.innerHTML = `<div style="font-size:13px;opacity:0.7;text-align:center">ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ñƒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑÑ‹Ğ³Ñ€Ğ°Ñ‚ÑŒ ĞµÑ‘</div>`;
  }
}

// â”€â”€ Card click handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onCardClick(index, phase) {
  if (phase === 'discard') {
    if (selectedDiscard.includes(index)) {
      selectedDiscard = selectedDiscard.filter(i => i !== index);
    } else if (selectedDiscard.length < 2) {
      selectedDiscard.push(index);
    } else {
      tg?.showAlert('Ğ£Ğ¶Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾ 2 ĞºĞ°Ñ€Ñ‚Ñ‹. Ğ¡Ğ½Ğ¸Ğ¼Ğ¸Ñ‚Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ¹.');
      return;
    }
    updateDiscardBtn();
    renderHand(state.hand, null, state.trump, 'discard');
  } else if (phase === 'play' && state.is_my_turn) {
    selectedPlayCard = index;
    renderHand(state.hand, state.valid_indices, state.trump, 'play');
    setTimeout(() => sendAction('play', index), 180);
  }
}

function updateDiscardBtn() {
  const btn = document.getElementById('confirm-discard-btn');
  btn.textContent = `ğŸ—‘ Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ (${selectedDiscard.length}/2)`;
  btn.style.opacity = selectedDiscard.length === 2 ? '1' : '0.5';
}

function confirmDiscard() {
  if (selectedDiscard.length !== 2) {
    tg?.showAlert('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ¾Ğ²Ğ½Ğ¾ 2 ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ°!');
    return;
  }
  sendAction('discard', selectedDiscard.join(','));
}

// â”€â”€ Game polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let gameRefreshTimer = null;

function startGamePolling() {
  stopGamePolling();
  gameRefreshTimer = setInterval(refreshGameState, 2000);
}

function stopGamePolling() {
  if (gameRefreshTimer) { clearInterval(gameRefreshTimer); gameRefreshTimer = null; }
}

async function refreshGameState() {
  if (!myId) return;
  // Only poll during active game phases
  const activePhases = ['bid1','bid2','play','declare','discard','waiting_discard'];
  if (!state || !activePhases.includes(state.phase)) return;
  // Don't refresh on my turn (would reset card selection)
  if (state.is_my_turn) return;
  try {
    const res = await fetch(`/api/game_state?player_id=${myId}`);
    const d = await res.json();
    if (d.ok && d.state && d.state.phase !== state.phase ||
        (d.ok && d.state && JSON.stringify(d.state.trick) !== JSON.stringify(state.trick))) {
      updateUI(d.state);
    }
  } catch(e) { /* ignore */ }
}

// â”€â”€ Communication with server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendAction(action, data) {
  if (!myId) return;
  stopGamePolling();

  // Optimistic: show "sending" state
  const statusEl = document.getElementById('status-bar');
  if (statusEl) { statusEl.textContent = 'â³ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°...'; statusEl.className = 'waiting'; }

  let respData;
  try {
    const res = await fetch('/api/action', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        player_id: myId,
        action,
        data: data !== undefined ? String(data) : null
      }),
    });
    respData = await res.json();
  } catch(e) {
    tg?.showAlert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·.');
    if (!tg) alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸: ' + e.message);
    startGamePolling();
    return;
  }

  if (!respData.ok) {
    tg?.showAlert(respData.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ');
    if (!tg) alert(respData.error);
    startGamePolling();
    return;
  }

  // Update UI with new state
  if (respData.state) {
    updateUI(respData.state);
  }

  startGamePolling();
}

// â”€â”€ Poll game state while in waiting room â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollGameState(gameId) {
  if (!myId) return;
  try {
    const res = await fetch(`/api/game_state?player_id=${myId}`);
    const data = await res.json();

    if (!data.ok) {
      // No longer in a game (kicked or closed)
      clearInterval(waitingRefreshTimer);
      showScreen('lobby-screen');
      loadLobby();
      lobbyRefreshTimer = setInterval(loadLobby, 5000);
      return;
    }

    const phase = data.state?.phase;

    // Still waiting â€” update player list
    if (phase === 'lobby_waiting') {
      showWaitingRoom(data.state);
      return;
    }

    // Game has started! Show it directly in webapp
    clearInterval(waitingRefreshTimer);
    updateUI(data.state);
  } catch (e) { /* ignore network errors */ }
}

// (showGameStartedScreen removed â€” game now shows directly)


// â”€â”€ Leave / close table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function leaveTable() {
  if (!myId) {
    tg?.showAlert('Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Telegram.');
    return;
  }

  const s = currentWaitingState;
  const isCreator = s?.is_creator || false;
  const confirmMsg = isCreator
    ? 'Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹? Ğ¡Ñ‚Ğ¾Ğ» Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ².'
    : 'Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ğ»Ğ°?';

  tg?.showConfirm(confirmMsg, async (confirmed) => {
    if (!confirmed) return;
    await doLeave();
  });

  // Fallback for non-Telegram browsers
  if (!tg) {
    if (!confirm(confirmMsg)) return;
    await doLeave();
  }
}

async function doLeave() {
  try {
    const res = await fetch('/api/leave_lobby', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ player_id: myId }),
    });
    const data = await res.json();
    if (!data.ok) {
      tg?.showAlert(data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°');
      return;
    }
    // Back to lobby
    clearInterval(waitingRefreshTimer);
    currentWaitingState = null;
    showScreen('lobby-screen');
    loadLobby();
    lobbyRefreshTimer = setInterval(loadLobby, 5000);
  } catch(e) {
    tg?.showAlert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·.');
  }
}


// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const hash = window.location.hash.slice(1);
  if (hash) {
    try {
      const decoded = JSON.parse(atob(hash));
      myId = decoded.my_id || myId;
      updateUI(decoded);
      return;
    } catch(e) {
      console.error('Failed to parse state from hash:', e);
    }
  }

  // No game state â€” show lobby
  showScreen('lobby-screen');
  loadLobby();
  // Auto-refresh lobby every 5s
  lobbyRefreshTimer = setInterval(loadLobby, 5000);
}

init();
</script>
</body>
</html>
